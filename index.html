<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DroneOps Editor | Lossless Batch Processor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root {
    --bg-color: #1a1a1a;
    --card-bg: #2d2d2d;
    --primary: #007bff;
    --primary-hover: #0056b3;
    --text-color: #e0e0e0;
    --border-color: #444;
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding-bottom: 50px;
}

header {
    background-color: var(--card-bg);
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid var(--border-color);
}

h1 { margin: 0; font-size: 1.2rem; color: #fff; margin-right: auto; }

.control-group { display: flex; gap: 10px; align-items: center; }

input[type="text"], input[type="date"] {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background: #404040;
    color: white;
}

button {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: bold;
}
button:hover { background-color: var(--primary-hover); }
button.secondary { background-color: #444; }
button.secondary:hover { background-color: #555; }

.upload-zone {
    margin: 20px auto;
    max-width: 800px;
    border: 2px dashed var(--border-color);
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background-color: var(--card-bg);
    transition: border-color 0.3s;
    cursor: pointer;
}
.upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); }

#imagesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
}

.image-card {
    background: var(--card-bg);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
}

canvas { max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

.progress-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: transparent;
    z-index: 200;
}
.progress-bar {
    height: 100%;
    width: 0%;
    background: #28a745;
    transition: width 0.3s;
}
.hidden { display: none; }
</style>
</head>
<body>

<header>
<h1>DroneOps Editor v3.0</h1>

<div class="control-group">
    <input type="text" id="description" placeholder="Project Name / Location" oninput="debouncedUpdate()">
    <input type="date" id="datePicker" onchange="updateImages()">
</div>

<div class="control-group">
    <button class="secondary" onclick="document.getElementById('logoUpload').click()">Change Logo</button>
    <input type="file" id="logoUpload" accept="image/*" class="hidden">

    <button onclick="downloadImages()">Download All (ZIP)</button>
</div>
</header>

<div class="upload-zone" id="dropZone" onclick="document.getElementById('imageUpload').click()">
<h3>Click or Drag Drone Photos Here</h3>
<p style="color: #888">Supports multiple JPG/PNG files</p>
<input type="file" id="imageUpload" accept="image/*" multiple class="hidden">
</div>

<div id="imagesContainer"></div>

<div class="progress-container">
<div class="progress-bar" id="progressBar"></div>
</div>

<script>
const state = {
    originalImages: new Map(),
    logoSrc: "data:image/png;base64,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"
};

const dom = {
    dropZone: document.getElementById('dropZone'),
    imageUpload: document.getElementById('imageUpload'),
    logoUpload: document.getElementById('logoUpload'),
    container: document.getElementById('imagesContainer'),
    description: document.getElementById('description'),
    datePicker: document.getElementById('datePicker'),
    progressBar: document.getElementById('progressBar')
};

// Set default date to today
dom.datePicker.valueAsDate = new Date();

// Drag & Drop
dom.dropZone.addEventListener("dragover", e => { e.preventDefault(); dom.dropZone.classList.add("dragover"); });
dom.dropZone.addEventListener("dragleave", () => dom.dropZone.classList.remove("dragover"));
dom.dropZone.addEventListener("drop", e => { e.preventDefault(); dom.dropZone.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });

// File inputs
dom.imageUpload.addEventListener("change", e => handleFiles(e.target.files));
dom.logoUpload.addEventListener("change", handleLogoUpload);

// Debounce
let timeout;
function debouncedUpdate() { clearTimeout(timeout); timeout = setTimeout(updateImages, 300); }

function handleFiles(files) {
    dom.container.innerHTML = "";
    state.originalImages.clear();

    [...files].forEach(file => {
        if (!file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = ev => {
            const div = document.createElement("div");
            div.className = "image-card";
            div.innerHTML = `<canvas></canvas>`;
            dom.container.appendChild(div);
            state.originalImages.set(div, ev.target.result);
            processImage(div);
        };
        reader.readAsDataURL(file);
    });
}

function handleLogoUpload(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => { state.logoSrc = ev.target.result; updateImages(); };
        reader.readAsDataURL(file);
    }
}

function updateImages() {
    state.originalImages.forEach((_, div) => processImage(div));
}

function processImage(div) {
    const canvas = div.querySelector("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // Draw Project Name and Date
        const descStr = dom.description.value.trim() || "Project";
        const dateStr = dom.datePicker.value || "";
        ctx.fillStyle = "white";
        ctx.font = `${Math.floor(canvas.width * 0.03)}px Arial`;
        ctx.textBaseline = "bottom";
        ctx.textAlign = "left";
        ctx.fillText(`${descStr} ${dateStr}`, 20, canvas.height - 20);

        // Draw logo if exists
        if (state.logoSrc) {
            const logo = new Image();
            logo.onload = () => {
                const logoWidth = img.width * 0.15;
                const logoHeight = logo.height / logo.width * logoWidth;
                ctx.globalAlpha = 0.8;
                ctx.drawImage(logo, img.width - logoWidth - 20, img.height - logoHeight - 20, logoWidth, logoHeight);
                ctx.globalAlpha = 1.0;
            };
            logo.src = state.logoSrc;
        }
    };
    img.src = state.originalImages.get(div);
}

function downloadImages() {
    const zip = new JSZip();
    const folderProcessed = zip.folder("Processed");
    const containers = Array.from(dom.container.querySelectorAll(".image-card"));
    if (!containers.length) return alert("No images uploaded!");

    let count = 0;
    containers.forEach((c, i) => {
        const canvas = c.querySelector("canvas");
        canvas.toBlob(blob => {
            const descStr = dom.description.value.trim().replace(/[\\/:*?"<>|]/g, "_") || "Project";
            const dateStr = dom.datePicker.value ? dom.datePicker.value.replace(/-/g, "") : "nodate";
            const seq = String(i + 1).padStart(3, '0');
            const filename = `${descStr}_${dateStr}_${seq}.jpg`;
            folderProcessed.file(filename, blob);

            count++;
            dom.progressBar.style.width = `${(count / containers.length) * 100}%`;

            if (count === containers.length) {
                zip.generateAsync({ type: "blob" }).then(content => {
                    saveAs(content, "DroneOps_Batch.zip");
                    setTimeout(() => { dom.progressBar.style.width = "0%"; }, 2000);
                });
            }
        }, "image/jpeg", 0.9);
    });
}
</script>
</body>
</html>
