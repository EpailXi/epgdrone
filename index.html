<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DroneOps Editor | Lossless Batch Processor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

<style>
:root {
    --bg:#1a1a1a;--card:#2d2d2d;--primary:#007bff;--text:#e0e0e0;--border:#444;
}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:var(--card);padding:12px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:1.1rem;margin-right:auto}
button{background:var(--primary);border:none;color:#fff;padding:8px 14px;border-radius:4px;cursor:pointer;font-weight:bold}
button.secondary{background:#444}
input{padding:7px;background:#404040;border:1px solid var(--border);color:#fff;border-radius:4px}
.upload-zone{margin:20px auto;max-width:800px;padding:40px;border:2px dashed var(--border);border-radius:10px;text-align:center;background:var(--card);cursor:pointer}
.upload-zone.dragover{border-color:var(--primary)}
#imagesContainer{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;padding:20px;max-width:1600px;margin:auto}
.image-card{background:var(--card);padding:10px;border-radius:8px}
canvas{max-width:100%;border-radius:4px}
.meta-info{font-size:.85rem;color:#aaa;margin-top:6px}
.progress-container{position:fixed;bottom:0;left:0;width:100%;height:5px}
.progress-bar{height:100%;width:0;background:#28a745;transition:width .3s}
.hidden{display:none}
</style>
</head>

<body>

<header>
<h1>DroneOps Editor v2.0</h1>
<input type="text" id="description" placeholder="Project / Location" oninput="debouncedUpdate()">
<input type="date" id="datePicker" onchange="updateImages()">
<button class="secondary" onclick="logoUpload.click()">Change Logo</button>
<button onclick="downloadImages()">Download All (ZIP)</button>
<input type="file" id="logoUpload" accept="image/*" class="hidden">
</header>

<div class="upload-zone" id="dropZone" onclick="imageUpload.click()">
<h3>Click or Drag Drone Photos Here</h3>
<p style="color:#888">JPG / PNG</p>
<input type="file" id="imageUpload" multiple accept="image/*" class="hidden">
</div>

<div id="imagesContainer"></div>

<div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

<script>
const state = {
    originalImages: new Map(),
    logoSrc: "data:image/png;base64,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"
};

const dom = {
    dropZone, imageUpload, logoUpload,
    container: imagesContainer,
    description, datePicker, progressBar
};

datePicker.valueAsDate = new Date();

imageUpload.onchange = e => handleFiles(e.target.files);
logoUpload.onchange = handleLogo;

dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = e => {
    e.preventDefault(); dropZone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
};

let debounce;
function debouncedUpdate(){
    clearTimeout(debounce);
    debounce=setTimeout(updateImages,300);
}

function handleFiles(files){
    container.innerHTML="";
    state.originalImages.clear();
    [...files].forEach(file=>{
        if(!file.type.startsWith("image/"))return;
        const r=new FileReader();
        r.onload=e=>{
            const div=document.createElement("div");
            div.className="image-card";
            div.innerHTML="<canvas></canvas><div class='meta-info'>"+file.name+"</div>";
            container.appendChild(div);
            state.originalImages.set(div,e.target.result);
            processImage(div);
        };
        r.readAsDataURL(file);
    });
}

function handleLogo(e){
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{state.logoSrc=ev.target.result;updateImages()};
    r.readAsDataURL(f);
}

function updateImages(){
    document.querySelectorAll(".image-card").forEach(processImage);
}

function formatDate(d){
    if(!d)return"";
    return new Date(d).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});
}

function processImage(card){
    const src=state.originalImages.get(card);
    if(!src)return;
    const canvas=card.querySelector("canvas");
    const ctx=canvas.getContext("2d");
    const img=new Image();
    img.src=src;
    img.onload=()=>{
        canvas.width=img.naturalWidth;
        canvas.height=img.naturalHeight;
        ctx.drawImage(img,0,0);
        const logo=new Image();
        logo.src=state.logoSrc;
        logo.onload=()=>drawOverlay(ctx,img,logo);
    };
}

function drawOverlay(ctx,img,logo){
    const pad=img.width*0.03;
    const scale=Math.min(img.width*0.2/logo.width,2);
    ctx.drawImage(logo,pad,pad,logo.width*scale,logo.height*scale);

    const h=Math.max(img.height*0.06,80);
    ctx.fillStyle="rgba(255,255,255,.9)";
    ctx.fillRect(0,img.height-h,img.width,h);

    const text=[description.value,formatDate(datePicker.value)].filter(Boolean).join(" | ");
    let fs=h*0.5;
    ctx.font=`bold ${fs}px Arial`;
    while(ctx.measureText(text).width>img.width-100&&fs>20){
        fs-=5;ctx.font=`bold ${fs}px Arial`;
    }
    ctx.fillStyle="#000";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(text,img.width/2,img.height-h/2);
}

const compressionOptions={
    maxSizeMB:5,
    maxWidthOrHeight:Infinity,
    initialQuality:1,
    useWebWorker:true,
    alwaysKeepResolution:true
};

function downloadImages(){
    const cards=[...document.querySelectorAll(".image-card")];
    if(!cards.length)return alert("Upload images first");
    const base=(description.value||"drone").replace(/[^a-z0-9]/gi,"_");
    if(cards.length===1){
        cards[0].querySelector("canvas").toBlob(async b=>{
            const c=await imageCompression(b,compressionOptions);
            saveAs(c,base+".png");
        },"image/png");
        return;
    }

    const zip=new JSZip(),folder=zip.folder("processed");
    let done=0;
    cards.forEach((c,i)=>{
        c.querySelector("canvas").toBlob(async b=>{
            const comp=await imageCompression(b,compressionOptions);
            folder.file(`${base}_${String(i+1).padStart(3,"0")}.png`,comp);
            done++;
            progressBar.style.width=(done/cards.length*100)+"%";
            if(done===cards.length){
                zip.generateAsync({type:"blob"}).then(z=>{
                    saveAs(z,base+"_BATCH.zip");
                    setTimeout(()=>progressBar.style.width="0%",1500);
                });
            }
        },"image/png");
    });
}
</script>

</body>
</html>
